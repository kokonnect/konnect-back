# .github/workflows/pr-gpt-review.yml
name: PR GPT Review
on: pull_request

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: ${{ !github.event.pull_request.draft }} # ë“œë˜í”„íŠ¸ PRì€ ìŠ¤í‚µ
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ë¦¬í¬ checkout (ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ diff ì•ˆì „í•˜ê²Œ ìƒì„±
      - name: Build unified diff (robust)
        shell: bash
        run: |
          set -euo pipefail

          BASE_REF="${{ github.event.pull_request.base.ref || 'main' }}"
          HEAD_REF="${{ github.event.pull_request.head.ref || '' }}"

          # ëª¨ë“  ì›ê²© ë¸Œëœì¹˜ fetch
          git fetch --no-tags --prune origin "+refs/heads/*:refs/remotes/origin/*" \
                                     "+refs/pull/*:refs/remotes/pull/*"

          HEAD_SHA=$(git rev-parse HEAD)
          if git rev-parse --verify "origin/${BASE_REF}" >/dev/null 2>&1; then
            BASE_REMOTE="origin/${BASE_REF}"
          else
            BASE_REMOTE="origin/main"
          fi

          BASE_SHA=$(git merge-base "${BASE_REMOTE}" "${HEAD_SHA}")
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          git diff -U0 --no-color "${BASE_SHA}" "${HEAD_SHA}" > diff.patch
          head -c 200000 diff.patch > diff.patch  # í† í° ì ˆì•½

      # 3ï¸âƒ£ GPT í˜¸ì¶œ ë° ë¦¬ë·° ì½”ë©˜íŠ¸ ë‹¬ê¸°
      - name: GPT review & comment
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4o-mini
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const diff = fs.readFileSync('diff.patch','utf8');
            const system = `
            ë„ˆëŠ” ê·¼ê±° ì¤‘ì‹¬ì˜ ì‹œë‹ˆì–´ ì½”ë“œë¦¬ë·°ì–´ë‹¤.
            ëª¨ë“  ì§€ì ì— label(blocker/major/minor/nit), file, line, evidence, suggestionì„ í¬í•¨í•´ë¼.
            ë³´ì•ˆ, ê³„ì•½, ì˜ˆì™¸, ì„±ëŠ¥, í…ŒìŠ¤íŠ¸ ê³µë°±ì„ ìš°ì„  í™•ì¸í•˜ê³  JSONìœ¼ë¡œë§Œ ì‘ë‹µí•˜ë¼.
            `;
            const user = `
            PR #${context.payload.pull_request.number} (${context.repo.owner}/${context.repo.repo})
            Title: ${context.payload.pull_request.title}
            Description: ${context.payload.pull_request.body || '(no body)'}
            [DIFF unified]
            ${diff}
            ìŠ¤í‚¤ë§ˆ:
            {"summary":"","decision":"approve|request-changes","findings":[{"label":"","file":"","line":0,"title":"","evidence":"","suggestion":""}],"tests_to_add":[]}
            `;

            const body = {
              model: process.env.OPENAI_MODEL,
              temperature: 0,
              response_format: { type: "json_object" },
              messages: [{ role: "system", content: system }, { role: "user", content: user }]
            };

            const r = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: { "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`, "Content-Type": "application/json" },
              body: JSON.stringify(body)
            });
            const j = await r.json();

            let data;
            try { data = JSON.parse(j.choices[0].message.content); }
            catch { data = { summary: "íŒŒì‹± ì‹¤íŒ¨", decision: "request-changes", findings: [], tests_to_add: [] }; }

            const findings = (data.findings||[]).map(f =>
              `- **[${f.label}]** \`${f.file}:${f.line}\` â€” ${f.title}\n  - ê·¼ê±°: ${f.evidence}\n  - ì œì•ˆ: ${f.suggestion}`
            ).join('\n') || '_ì§€ì  ì—†ìŒ_';

            const comment =
              `### ğŸ¤– GPT PR Review\n` +
              `**ê²°ë¡ :** ${data.decision}\n\n` +
              `**ìš”ì•½:** ${data.summary}\n\n` +
              `#### ì£¼ìš” ì§€ì \n${findings}` +
              (data.tests_to_add?.length ? `\n\n#### ì œì•ˆ í…ŒìŠ¤íŠ¸\n- ${data.tests_to_add.join('\n- ')}` : '');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
