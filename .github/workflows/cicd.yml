name: konnect-backend CI/CD (simple)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Build
        run: |
          chmod +x gradlew
          ./gradlew clean bootJar -x test

      - name: Find jar
        id: jar
        run: echo "path=$(ls -1 build/libs/*.jar | head -n 1)" >> $GITHUB_OUTPUT

      - name: Prepare SSH
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${PROD_SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${PROD_SSH_PORT:-22} ${PROD_HOST} >> ~/.ssh/known_hosts

      - name: Upload jar
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
        run: |
          scp -P ${PROD_SSH_PORT:-22} -i ~/.ssh/id_rsa \
            "${{ steps.jar.outputs.path }}" \
            "${PROD_USER}@${PROD_HOST}:/tmp/konnect-backend.jar"

      - name: Restart app (nohup)
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
          PROD_APP_DIR: ${{ secrets.PROD_APP_DIR }}
          PROD_SERVER_PORT: ${{ secrets.PROD_SERVER_PORT }}
        run: |
          ssh -p ${PROD_SSH_PORT:-22} -i ~/.ssh/id_rsa ${PROD_USER}@${PROD_HOST} bash -euo pipefail -c '
            APP_DIR="${PROD_APP_DIR:-$HOME/konnect-backend}"
            PORT="${PROD_SERVER_PORT:-8080}"
            mkdir -p "$APP_DIR"
            mv /tmp/konnect-backend.jar "$APP_DIR/app.jar"

            # 기존 프로세스 종료(있으면)
            pids=$(pgrep -f "java .*${APP_DIR}/app.jar" || true)
            if [ -n "$pids" ]; then kill $pids || true; sleep 2; fi

            # 재기동
            nohup java -jar "$APP_DIR/app.jar" \
              --server.address=0.0.0.0 \
              --server.port="$PORT" \
              > "$APP_DIR/app.log" 2>&1 &

            echo "Restarted. Log: $APP_DIR/app.log"
          '
